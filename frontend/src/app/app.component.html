<div class="min-h-dvh bg-[var(--bg)] text-[var(--ink)]">
  <mat-toolbar class="app-header flex h-14 items-center gap-2 border-b border-white/10 px-2.5 text-[var(--on-brand)] shadow-lg md:h-[68px] md:gap-3 md:px-5" role="banner">
    <div class="flex min-w-0 items-center gap-2 md:gap-3">
      <button mat-icon-button *ngIf="hasTenant" (click)="toggleSidebar()" aria-label="Alternar menu lateral">
        <mat-icon>menu</mat-icon>
      </button>

      <div class="inline-flex min-w-0 items-center gap-2 md:gap-3" aria-label="Sistema de Gestão de Negócios">
        <span class="hidden h-10 w-10 place-items-center rounded-xl border border-white/35 bg-white shadow sm:grid" aria-hidden="true">
          <mat-icon class="text-[#1e3a6d]">business</mat-icon>
        </span>
        <div class="grid min-w-0 leading-tight">
          <span class="block truncate text-sm font-semibold text-[#f5fbfd] sm:hidden">SGN</span>
          <span class="hidden truncate text-sm font-semibold text-[#f5fbfd] sm:block md:text-base">Sistema de Gestão de Negócios</span>
          <span class="hidden text-xs text-white/80 md:block" *ngIf="hasTenant">Ambiente do locatário</span>
        </div>
      </div>
    </div>

    <div class="hidden flex-1 items-center gap-3 lg:flex" *ngIf="hasTenant">
      <div class="h-7 w-px bg-white/20"></div>
      <button mat-button routerLink="/home" aria-label="Home" matTooltip="Ir para Home" class="inline-flex items-center gap-1 rounded-full border border-white/20 bg-white/10 px-3 text-xs text-[#f5fbfd]">
        <mat-icon>home</mat-icon>
        <span>Home</span>
      </button>
      <div class="flex min-w-0 flex-1 items-center gap-2" aria-label="Navegação rápida">
        <ng-container *ngFor="let s of atalhosTop">
          <button mat-button [routerLink]="s.route" [ngClass]="isActiveRoute(s.route) ? 'bg-white/20' : ''" class="inline-flex items-center gap-1 rounded-full border border-white/20 bg-white/10 px-3 text-xs text-[#f5fbfd]">
            <mat-icon>{{ s.icon }}</mat-icon>
            <span class="max-w-40 truncate" [attr.title]="s.label">{{ getMenuLabel(s) }}</span>
          </button>
        </ng-container>
        <button mat-icon-button (click)="openOrdenar()" aria-label="Ordenar atalhos rápidos" matTooltip="Ordenar atalhos" class="h-8 w-8 rounded-md bg-white/15 text-[#f5fbfd]">
          <mat-icon>reorder</mat-icon>
        </button>
      </div>
    </div>

    <span class="flex-1"></span>

    <div class="flex items-center gap-2">
      <div class="header-company-context hidden items-center gap-1.5 rounded-lg border border-white/25 bg-white/10 px-2 py-1 lg:flex" *ngIf="hasTenant && !isSelectionRoute">
        <mat-icon class="header-company-context-icon">corporate_fare</mat-icon>
        <select
          class="header-company-context-select"
          [ngModel]="empresaContextId"
          (ngModelChange)="onEmpresaContextChange($event)"
          [ngModelOptions]="{ standalone: true }"
          [disabled]="loadingEmpresaContext"
          aria-label="Selecionar empresa ou filial do contexto">
          <option [ngValue]="null" disabled *ngIf="!empresaContextId">Selecione uma empresa</option>
          <option *ngFor="let empresa of empresaContextOptions" [ngValue]="empresa.id">
            {{ empresaContextLabel(empresa) }}
          </option>
        </select>
        <span *ngIf="isEmpresaPadraoSelecionada()" class="header-company-default-badge">Padrão</span>
      </div>
      <div class="header-company-context header-company-context-mobile flex items-center gap-1 rounded-lg border border-white/25 bg-white/10 px-1.5 py-1 lg:hidden" *ngIf="hasTenant && !isSelectionRoute">
        <mat-icon class="header-company-context-icon">corporate_fare</mat-icon>
        <select
          class="header-company-context-select"
          [ngModel]="empresaContextId"
          (ngModelChange)="onEmpresaContextChange($event)"
          [ngModelOptions]="{ standalone: true }"
          [disabled]="loadingEmpresaContext"
          aria-label="Selecionar empresa ou filial do contexto no celular">
          <option [ngValue]="null" disabled *ngIf="!empresaContextId">Empresa</option>
          <option *ngFor="let empresa of empresaContextOptions" [ngValue]="empresa.id">
            {{ empresaContextLabel(empresa) }}
          </option>
        </select>
      </div>

      <button mat-icon-button routerLink="/help" aria-label="Ajuda" matTooltip="Ajuda" *ngIf="hasTenant" class="hidden h-9 w-9 rounded-xl bg-white/15 text-white min-[420px]:inline-flex">
        <mat-icon>help_outline</mat-icon>
      </button>

      <div *ngIf="loggedIn; else loginActions">
        <button mat-button [matMenuTriggerFor]="userMenu" aria-label="Abrir menu do usuário" class="inline-flex h-12 items-center gap-2 rounded-xl bg-white/15 px-2 text-[#f2fbfc]">
          <div class="flex min-w-0 flex-col items-center justify-center">
            <span class="grid h-8 w-8 place-items-center rounded-full bg-white/25 text-sm font-bold leading-none">{{ userInitials }}</span>
            <span class="max-w-20 truncate pt-0.5 text-[10px] font-semibold leading-none">{{ userName }}</span>
          </div>
          <mat-icon class="text-[20px]">expand_more</mat-icon>
        </button>
        <mat-menu #userMenu="matMenu">
          <button mat-menu-item (click)="logout()">
            <mat-icon>logout</mat-icon>
            <span>Sair</span>
          </button>
        </mat-menu>
      </div>
      <ng-template #loginActions>
        <button mat-stroked-button (click)="login()">Login</button>
      </ng-template>
    </div>
  </mat-toolbar>

  <mat-sidenav-container class="h-[calc(100dvh-56px)] md:h-[calc(100dvh-68px)]">
    <mat-sidenav #sidenav [mode]="isMobile ? 'over' : 'side'" [opened]="sidebarOpen" [fixedInViewport]="isMobile" [disableClose]="!isMobile" *ngIf="hasTenant" class="w-60 border-r border-[var(--border)] bg-[linear-gradient(180deg,#f8fafc_0%,#f1f5f9_100%)]" role="navigation">
      <div class="grid gap-0.5 px-3.5 pb-1 pt-3">
        <span class="text-xs font-semibold uppercase tracking-[0.6px] text-[var(--muted)]">Navegação</span>
        <span class="text-xs text-[var(--muted-strong)]">Favoritos e módulos</span>
      </div>
      <mat-nav-list class="px-2 pb-3">
        <ng-container *ngFor="let item of menu">
          <ng-container *ngIf="item.children?.length; else singleItem">
            <div class="mx-2 my-2 border-t border-[var(--border-light)] pt-2">
              <div class="px-2 text-[11px] font-semibold uppercase tracking-[0.5px] text-[var(--muted)]">{{ getMenuLabel(item) }}</div>
            </div>
            <a
              mat-list-item
              *ngFor="let child of item.children"
              [routerLink]="child.route"
              [ngClass]="isActiveRoute(child.route) ? 'bg-[#dfe8f3] text-[var(--ink)]' : ''"
              class="sidebar-menu-item my-0.5 flex min-h-9 items-center gap-2 rounded-xl px-2 text-[var(--muted)] hover:bg-[var(--hover)] hover:text-[var(--ink)]">
              <mat-icon class="menu-left-icon">{{ child.icon }}</mat-icon>
              <span class="menu-item-label truncate text-sm" [attr.title]="child.label">{{ getMenuLabel(child) }}</span>
              <div class="menu-right-actions ml-auto inline-flex items-center gap-0.5">
                <button
                  type="button"
                  class="menu-mini-action"
                  (click)="toggleShortcut(child); $event.preventDefault(); $event.stopPropagation();"
                  [attr.aria-pressed]="isShortcut(child.id)"
                  aria-label="Fixar ou desfazer atalho">
                  <mat-icon [style.color]="isShortcut(child.id) ? '#d08a00' : null">
                    {{ isShortcut(child.id) ? 'star' : 'star_outline' }}
                  </mat-icon>
                </button>
                <button
                  *ngIf="canConfigureAccess()"
                  type="button"
                  class="menu-mini-action"
                  [attr.aria-label]="'Configurar acesso de ' + getMenuLabel(child)"
                  (click)="configureMenuAccess(child, $event)"
                  title="Configurar acesso">
                  <mat-icon>shield</mat-icon>
                </button>
              </div>
            </a>
          </ng-container>

          <ng-template #singleItem>
            <a
              mat-list-item
              [routerLink]="item.route"
              [ngClass]="isActiveRoute(item.route) ? 'bg-[#dfe8f3] text-[var(--ink)]' : ''"
              class="sidebar-menu-item my-0.5 flex min-h-10 items-center gap-2 rounded-xl px-3 text-[var(--muted)] hover:bg-[var(--hover)] hover:text-[var(--ink)]">
              <mat-icon class="menu-left-icon">{{ item.icon }}</mat-icon>
              <span class="menu-item-label truncate text-sm">{{ item.label }}</span>
              <div class="menu-right-actions ml-auto inline-flex items-center gap-0.5">
                <button
                  type="button"
                  class="menu-mini-action"
                  (click)="toggleShortcut(item); $event.preventDefault(); $event.stopPropagation();"
                  [attr.aria-pressed]="isShortcut(item.id)"
                  aria-label="Fixar ou desfazer atalho">
                  <mat-icon [style.color]="isShortcut(item.id) ? '#d08a00' : null">
                    {{ isShortcut(item.id) ? 'star' : 'star_outline' }}
                  </mat-icon>
                </button>
                <button
                  *ngIf="canConfigureAccess()"
                  type="button"
                  class="menu-mini-action"
                  [attr.aria-label]="'Configurar acesso de ' + getMenuLabel(item)"
                  (click)="configureMenuAccess(item, $event)"
                  title="Configurar acesso">
                  <mat-icon>shield</mat-icon>
                </button>
              </div>
            </a>
          </ng-template>
        </ng-container>
      </mat-nav-list>
    </mat-sidenav>

    <mat-sidenav-content class="bg-[var(--bg)]">
      <div class="p-3.5">
        <router-outlet></router-outlet>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>




