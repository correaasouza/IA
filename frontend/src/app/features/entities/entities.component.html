<div class="grid gap-3 lg:grid-cols-[320px_minmax(0,1fr)]">
  <mat-card class="rounded-xl border border-[var(--border)] bg-[var(--surface)] shadow-[var(--shadow-xs)]">
    <mat-card-title>Cadastros</mat-card-title>
    <mat-card-content>
      <mat-form-field appearance="outline">
        <mat-label>Tipo</mat-label>
        <mat-select [(ngModel)]="selectedDefId" (selectionChange)="changeDef()" aria-label="Tipo de entidade">
          <mat-option *ngFor="let d of definicoes" [value]="d.id">{{ d.nome }}</mat-option>
        </mat-select>
      </mat-form-field>
      <form [formGroup]="form" (ngSubmit)="save()" class="grid gap-2">
        <mat-form-field appearance="outline" *ngIf="visible.nome">
          <mat-label>{{ labels.nome }}</mat-label>
          <input matInput formControlName="nome" [readonly]="!editable.nome" aria-describedby="ent-nome-err" />
          <mat-error id="ent-nome-err" *ngIf="form.get('nome')?.hasError('required')">Informe o nome.</mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="visible.apelido">
          <mat-label>{{ labels.apelido }}</mat-label>
          <input matInput formControlName="apelido" [readonly]="!editable.apelido" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Tipo de pessoa</mat-label>
          <mat-select formControlName="tipoPessoa">
            <mat-option value="FISICA">Pessoa física</mat-option>
            <mat-option value="JURIDICA">Pessoa jurídica</mat-option>
            <mat-option value="ESTRANGEIRA">Pessoa estrangeira</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="visible.cpfCnpj && form.get('tipoPessoa')?.value !== 'ESTRANGEIRA'">
          <mat-label>{{ documentoLabel }}</mat-label>
          <input matInput formControlName="cpfCnpj" [readonly]="!editable.cpfCnpj" appCpfCnpjMask aria-describedby="legacy-cpf-err" />
          <mat-error id="legacy-cpf-err" *ngIf="form.get('cpfCnpj')?.hasError('required')">Informe o documento.</mat-error>
          <mat-error *ngIf="form.get('cpfCnpj')?.hasError('cpf')">CPF inválido.</mat-error>
          <mat-error *ngIf="form.get('cpfCnpj')?.hasError('cnpj')">CNPJ inválido.</mat-error>
          <mat-error *ngIf="form.get('cpfCnpj')?.hasError('cpfCnpj')">Documento inválido.</mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" *ngIf="visible.cpfCnpj && form.get('tipoPessoa')?.value === 'ESTRANGEIRA'">
          <mat-label>{{ documentoLabel }}</mat-label>
          <input matInput formControlName="cpfCnpj" [readonly]="!editable.cpfCnpj" aria-describedby="legacy-cpf-err" />
          <mat-error id="legacy-cpf-err" *ngIf="form.get('cpfCnpj')?.hasError('required')">Informe o documento.</mat-error>
        </mat-form-field>
        <mat-slide-toggle formControlName="ativo" aria-label="Ativo">Ativo</mat-slide-toggle>
        <button mat-flat-button color="primary" type="submit" aria-label="Salvar cadastro">Salvar</button>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card class="rounded-xl border border-[var(--border)] bg-[var(--surface)] shadow-[var(--shadow-xs)]">
    <mat-card-title>Tipos e permissões</mat-card-title>
    <mat-card-content>
      <table mat-table [dataSource]="definicoes" class="w-full">
        <ng-container matColumnDef="nome">
          <th mat-header-cell *matHeaderCellDef>Nome</th>
          <td mat-cell *matCellDef="let row">{{ row.nome }}</td>
        </ng-container>
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Role requerida</th>
          <td mat-cell *matCellDef="let row">
            <input matInput [value]="row.roleRequired" (input)="row.roleRequired = $any($event.target).value" aria-label="Role requerida" />
          </td>
        </ng-container>
        <ng-container matColumnDef="ativo">
          <th mat-header-cell *matHeaderCellDef>Ativo</th>
          <td mat-cell *matCellDef="let row">
            <mat-slide-toggle [(ngModel)]="row.ativo" aria-label="Ativo"></mat-slide-toggle>
          </td>
        </ng-container>
        <ng-container matColumnDef="save">
          <th mat-header-cell *matHeaderCellDef>Ação</th>
          <td mat-cell *matCellDef="let row">
            <button mat-stroked-button (click)="saveDef(row)" [attr.aria-label]="'Salvar ' + row.nome">Salvar</button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="defColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: defColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <mat-card class="rounded-xl border border-[var(--border)] bg-[var(--surface)] shadow-[var(--shadow-xs)] lg:col-span-2">
    <mat-card-title>Registros</mat-card-title>
    <mat-card-content>
      <form [formGroup]="filters" class="mb-2 grid grid-cols-1 items-end gap-2 lg:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_160px_120px_auto]" role="search">
        <mat-form-field appearance="outline">
          <mat-label>Nome</mat-label>
          <input matInput formControlName="nome" aria-label="Filtrar por nome" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Tipo de pessoa</mat-label>
          <mat-select formControlName="tipoPessoa" aria-label="Filtrar por tipo de pessoa">
            <mat-option value="">Todos</mat-option>
            <mat-option value="FISICA">Pessoa física</mat-option>
            <mat-option value="JURIDICA">Pessoa jurídica</mat-option>
            <mat-option value="ESTRANGEIRA">Pessoa estrangeira</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{ filterDocumentoLabel }}</mat-label>
          <input matInput formControlName="cpfCnpj" aria-label="Filtrar por documento" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="ativo" aria-label="Filtrar por status">
            <mat-option value="">Todos</mat-option>
            <mat-option value="true">Ativo</mat-option>
            <mat-option value="false">Inativo</mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-stroked-button type="button" (click)="applyFilters()" aria-label="Aplicar filtros">Filtrar</button>
      </form>

      <div class="overflow-auto">
        <table mat-table [dataSource]="registros" class="w-full">
          <ng-container matColumnDef="nome">
            <th mat-header-cell *matHeaderCellDef>{{ labels.nome }}</th>
            <td mat-cell *matCellDef="let row">
              <ng-container *ngIf="editingRowId === row.id; else nomeView">
                <input matInput [(ngModel)]="editingRow.nome" aria-label="Nome" />
              </ng-container>
              <ng-template #nomeView>{{ row.nome }}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="apelido" *ngIf="visible.apelido">
            <th mat-header-cell *matHeaderCellDef>{{ labels.apelido }}</th>
            <td mat-cell *matCellDef="let row">
              <ng-container *ngIf="editingRowId === row.id; else apelidoView">
                <input matInput [(ngModel)]="editingRow.apelido" aria-label="Apelido" />
              </ng-container>
              <ng-template #apelidoView>{{ row.apelido }}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="cpfCnpj">
            <th mat-header-cell *matHeaderCellDef>{{ labels.cpfCnpj }}</th>
            <td mat-cell *matCellDef="let row">
              <ng-container *ngIf="editingRowId === row.id; else cpfView">
                <ng-container *ngIf="(editingRow.tipoPessoa || resolveTipoPessoa(editingRow.cpfCnpj)) !== 'ESTRANGEIRA'; else docForeign">
                  <input matInput [(ngModel)]="editingRow.cpfCnpj" appCpfCnpjMask aria-label="Documento" />
                </ng-container>
                <ng-template #docForeign>
                  <input matInput [(ngModel)]="editingRow.cpfCnpj" aria-label="Documento estrangeiro" />
                </ng-template>
              </ng-container>
              <ng-template #cpfView>{{ row.cpfCnpj }}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="ativo">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let row">
              <ng-container *ngIf="editingRowId === row.id; else ativoView">
                <mat-slide-toggle [(ngModel)]="editingRow.ativo" aria-label="Ativo"></mat-slide-toggle>
              </ng-container>
              <ng-template #ativoView>{{ row.ativo ? 'Ativo' : 'Inativo' }}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="acoes">
            <th mat-header-cell *matHeaderCellDef>Ações</th>
            <td mat-cell *matCellDef="let row">
              <button mat-stroked-button *ngIf="editingRowId !== row.id" (click)="editRow(row)" [attr.aria-label]="'Editar ' + row.nome">Editar</button>
              <button mat-stroked-button *ngIf="editingRowId === row.id" (click)="saveRow()" aria-label="Salvar edição">Salvar</button>
              <button mat-button *ngIf="editingRowId === row.id" (click)="cancelEdit()" aria-label="Cancelar edição">Cancelar</button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="columns"></tr>
          <tr mat-row *matRowDef="let row; columns: columns;" (click)="selectRegistro(row)" tabindex="0" (keydown.enter)="selectRegistro(row)"></tr>
        </table>
      </div>
      <mat-paginator [length]="totalElements" [pageSize]="pageSize" [pageIndex]="pageIndex"
        [pageSizeOptions]="[10,25,50]" (page)="pageChange($event)"></mat-paginator>
    </mat-card-content>
  </mat-card>

  <app-contato-tipos class="lg:col-span-2"></app-contato-tipos>
  <app-contato-tipos-por-entidade class="lg:col-span-2" [entidadeDefinicaoId]="selectedDefId"></app-contato-tipos-por-entidade>
  <app-contatos class="lg:col-span-2" [entidadeRegistroId]="selectedRegistroId"></app-contatos>
</div>
