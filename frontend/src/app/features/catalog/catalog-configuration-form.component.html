<app-config-section-shell
  [title]="'Configuracoes por Grupo de Empresas - ' + typeLabel()"
  subtitle="Cada agrupador possui configuracao propria de numeracao."
  [hasActions]="true">
  <div shell-actions>
    <span class="inline-flex items-center rounded-full border border-[var(--border-light)] bg-[var(--surface-muted)] px-2 py-0.5 text-xs text-[var(--muted-strong)]">
      Versao base: {{ config?.version ?? '-' }}
    </span>
  </div>

  <div class="rounded-lg border border-dashed border-[var(--border)] bg-[var(--surface-muted)] p-2.5 text-xs text-[var(--muted)]" *ngIf="loading">
    Carregando configuracao base...
  </div>

  <div class="rounded-lg border border-dashed border-[#fda29b] bg-[#fef3f2] p-2.5 text-xs text-[#b42318]" *ngIf="!loading && error">
    {{ error }}
  </div>

  <div class="rounded-lg border border-dashed border-[var(--border)] bg-[var(--surface-muted)] p-2.5 text-xs text-[var(--muted)]" *ngIf="!loading && !error && groupsLoading">
    Carregando configuracoes por agrupador...
  </div>

  <div class="rounded-lg border border-dashed border-[#fda29b] bg-[#fef3f2] p-2.5 text-xs text-[#b42318]" *ngIf="!loading && !groupsLoading && groupsError">
    {{ groupsError }}
  </div>

  <app-agrupadores-empresa
    *ngIf="!loading && config?.id && !error"
    [configType]="'CATALOGO'"
    [configId]="config.id"
    [configReferenceName]="configReferenceName()"
    (configure)="openGroupConfigModal($event)"
    (changed)="onGroupsChanged()">
  </app-agrupadores-empresa>
</app-config-section-shell>

<ng-template #groupConfigDialog>
  <section class="catalog-group-config-modal rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]">
    <div class="mb-3 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div class="min-w-0">
        <div class="text-sm font-semibold">Configuracao por Grupo de Empresas</div>
        <div class="text-xs text-[var(--muted)]">Defina a numeracao especifica para o agrupador selecionado.</div>
        <div class="mt-2 text-xs text-[var(--muted-strong)]"><strong>Origem:</strong> {{ configReferenceName() }}</div>
        <div class="mt-1 text-xs text-[var(--muted-strong)]"><strong>Grupo:</strong> {{ groupReference() }}</div>
        <div class="mt-2">
          <div class="text-xs font-semibold text-[var(--muted-strong)]">Empresas do grupo ({{ groupModalEmpresas.length }})</div>
          <div class="catalog-group-empresa-list mt-1" *ngIf="groupModalEmpresas.length > 0; else noEmpresaOnGroupModal">
            <span class="catalog-group-empresa-chip" *ngFor="let item of groupModalEmpresas">{{ item.nome }}</span>
          </div>
          <ng-template #noEmpresaOnGroupModal>
            <div class="text-xs text-[var(--muted)]">Nenhuma empresa vinculada neste grupo.</div>
          </ng-template>
        </div>
      </div>
      <div class="flex flex-wrap justify-end gap-2">
        <button
          mat-stroked-button
          type="button"
          (click)="openGroupEditorFromModal()"
          [disabled]="!groupModalId || groupModalSaving">
          <mat-icon>tune</mat-icon>
          Configurar grupo
        </button>
        <button mat-stroked-button type="button" (click)="closeGroupConfigModal()" [disabled]="groupModalSaving">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        <button mat-flat-button color="primary" type="button" (click)="saveGroupConfigModal()" [disabled]="groupModalSaving || !groupModalId">
          <mat-icon>save</mat-icon>
          Salvar
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-2.5">
      <div class="text-xs font-semibold uppercase tracking-[0.4px] text-[var(--muted-strong)]">Numeracao</div>
      <mat-radio-group
        [(ngModel)]="groupModalNumberingMode"
        [ngModelOptions]="{ standalone: true }"
        class="catalog-numbering-options"
        aria-label="Selecionar modo de numeracao do agrupador">
        <mat-radio-button value="AUTOMATICA">Numeracao automatica</mat-radio-button>
        <mat-radio-button value="MANUAL">Numeracao manual</mat-radio-button>
      </mat-radio-group>
    </div>

    <div class="mt-2 flex justify-end" *ngIf="groupModalSaving">
      <app-inline-loader label="Salvando configuracao"></app-inline-loader>
    </div>
  </section>
</ng-template>
