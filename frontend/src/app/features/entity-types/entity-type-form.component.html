<div class="entity-type-form-shell grid gap-3">
  <header class="entity-type-form-header page-header-sticky flex flex-col items-start justify-between gap-3 md:flex-row md:items-end">
    <div>
      <h1 class="m-0 text-lg font-bold">{{ title }}</h1>
      <p class="mt-1 text-xs text-[var(--muted)]" *ngIf="tipoEntidade">ID {{ tipoEntidade.id }}</p>
      <p class="mt-1 text-xs text-[var(--muted-strong)]">Nome: {{ form.get('nome')?.value || tipoEntidade?.nome || '-' }}</p>
    </div>
    <div class="entity-type-form-header-actions flex flex-wrap gap-2">
      <button class="entity-type-form-header-btn" mat-stroked-button type="button" (click)="back()">
        <mat-icon>arrow_back</mat-icon>
        Voltar
      </button>
      <button class="entity-type-form-header-btn" mat-stroked-button *ngIf="mode === 'view'" type="button" (click)="toEdit()">
        <mat-icon>edit</mat-icon>
        Alterar
      </button>
      <button class="entity-type-form-header-btn" mat-flat-button color="primary" *ngIf="mode !== 'view'" type="button" (click)="save()" [disabled]="saving">
        <mat-icon>save</mat-icon>
        Salvar
      </button>
      <button
        class="entity-type-form-header-btn"
        mat-button
        color="warn"
        *ngIf="tipoEntidade && mode !== 'new' && !tipoEntidade.tipoPadrao"
        type="button"
        (click)="remove()"
        [disabled]="deleting">
        <mat-icon>delete</mat-icon>
        Excluir
      </button>
    </div>
  </header>

  <section class="entity-type-card mt-1 rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]">
    <div class="mb-2.5 flex items-center justify-between gap-2">
      <div class="text-sm font-semibold">Dados do tipo</div>
      <span
        *ngIf="tipoEntidade?.tipoPadrao"
        class="inline-flex items-center justify-center rounded-full bg-[var(--info-bg)] px-2 py-0.5 text-xs font-semibold text-[var(--info-ink)]">
        Padrao do Sistema
      </span>
    </div>

    <form [formGroup]="form" class="grid grid-cols-1 gap-2.5 md:grid-cols-2">
      <mat-form-field appearance="outline">
        <mat-label>Nome</mat-label>
        <input matInput formControlName="nome" aria-describedby="tipo-entidade-nome-err" />
        <mat-error id="tipo-entidade-nome-err" *ngIf="form.get('nome')?.hasError('required')">Informe o nome.</mat-error>
      </mat-form-field>

      <div class="entity-type-status-toggle flex items-center pt-2">
        <mat-slide-toggle formControlName="ativo">Ativo</mat-slide-toggle>
      </div>

      <div class="col-span-full flex justify-end" *ngIf="loading">
        <app-inline-loader label="Carregando dados"></app-inline-loader>
      </div>
      <div class="col-span-full flex justify-end" *ngIf="saving">
        <app-inline-loader label="Salvando"></app-inline-loader>
      </div>
      <div class="col-span-full flex justify-end" *ngIf="deleting">
        <app-inline-loader label="Excluindo"></app-inline-loader>
      </div>
    </form>
  </section>

  <section
    *ngIf="tipoEntidade?.id"
    class="entity-type-card rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]">
    <div class="mb-2.5">
      <div class="text-sm font-semibold">Configuracoes por Grupo de Empresas</div>
      <div class="text-xs text-[var(--muted)]">Use a ficha do agrupador com guias de Filiais, Configuracoes e Tipos de Estoque.</div>
    </div>

    <app-agrupadores-empresa
      [configType]="'TIPO_ENTIDADE'"
      [configId]="tipoEntidade!.id"
      [configReferenceName]="configOriginName()"
      (groupEditStarted)="onGroupEditStarted($event)"
      (changed)="onAgrupadoresChanged()">

      <ng-template #agrupadorConfigTab let-group="group">
        <section class="entity-type-config-tab-shell">
          <div class="entity-type-config-ref">Grupo em edicao: <strong>{{ group?.nome || configTabGroupNome || '-' }}</strong></div>

          <div class="entity-type-config-card">
            <div class="entity-type-config-title">Regras do agrupador</div>
            <div class="flex items-center pt-2">
              <mat-slide-toggle
                [(ngModel)]="configTabObrigarUmTelefone"
                [ngModelOptions]="{ standalone: true }"
                [disabled]="mode === 'view' || configTabSaving">
                Obrigar um telefone
              </mat-slide-toggle>
            </div>
            <div class="entity-type-config-actions">
              <button mat-flat-button color="primary" type="button" (click)="saveConfigTab()" [disabled]="mode === 'view' || configTabSaving || !configTabGroupId">
                <mat-icon>save</mat-icon>
                Salvar configuracao
              </button>
            </div>
          </div>

          <div class="mt-2 flex justify-end" *ngIf="configTabSaving">
            <app-inline-loader label="Salvando configuracao"></app-inline-loader>
          </div>
        </section>
      </ng-template>
    </app-agrupadores-empresa>
  </section>
</div>
