<div class="grid gap-3">
  <div class="page-list-sticky grid gap-3" *ngIf="canUseModule; else moduleDisabledTpl">
    <header class="flex flex-col items-start justify-between gap-3 md:flex-row md:items-end">
      <div>
        <h1 class="m-0 text-lg font-bold">Workflows</h1>
        <p class="mt-1 text-xs text-[var(--muted)]">Configuracao por origem e configuracao de movimento.</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button
          mat-stroked-button
          type="button"
          (click)="loadAll()"
          appAccessControl="workflow.configurar"
          [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
          <mat-icon>refresh</mat-icon>
          Atualizar
        </button>
        <button
          mat-stroked-button
          type="button"
          (click)="importJson()"
          appAccessControl="workflow.configurar"
          [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
          <mat-icon>upload_file</mat-icon>
          Importar JSON
        </button>
      </div>
    </header>

    <section class="workflow-context-card">
      <mat-form-field appearance="outline" class="workflow-context-field">
        <mat-label>Configuracao de movimento</mat-label>
        <mat-select
          [(ngModel)]="selectedMovimentoConfigId"
          [disabled]="loadingConfigs || movimentoConfigs.length === 0"
          (selectionChange)="onMovimentoConfigChange()">
          <mat-option *ngFor="let config of movimentoConfigs" [value]="config.id">
            {{ config.nome }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <p class="workflow-context-help" *ngIf="movimentoConfigs.length === 0">
        Nenhuma configuracao de movimento ativa encontrada.
      </p>
    </section>
  </div>

  <section class="workflow-origin-grid" *ngIf="canUseModule && selectedMovimentoConfigId">
    <article class="workflow-origin-card" *ngFor="let card of cards">
      <div class="workflow-origin-card-header">
        <div>
          <h2 class="workflow-origin-title">{{ originLabel(card.origin) }}</h2>
          <p class="workflow-origin-hint">{{ originHint(card.origin) }}</p>
        </div>
        <span class="workflow-origin-state" [class.workflow-origin-state--ok]="!!card.definition">
          {{ card.definition ? 'Configurado' : 'Nao configurado' }}
        </span>
      </div>

      <div class="workflow-origin-body" *ngIf="!card.loading; else loadingCardTpl">
        <p class="workflow-origin-meta" *ngIf="card.definition">
          Ultima versao: v{{ card.definition.versionNum }} | status: {{ card.definition.status }}
        </p>
        <p class="workflow-origin-meta" *ngIf="card.definition?.updatedAt">
          Atualizado em {{ card.definition?.updatedAt | date : 'dd/MM/yyyy HH:mm' }}
        </p>

        <div class="workflow-origin-actions">
          <button
            mat-flat-button
            color="primary"
            type="button"
            (click)="openConfiguration(card)"
            appAccessControl="workflow.configurar"
            [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
            <mat-icon>{{ card.definition ? 'edit' : 'add' }}</mat-icon>
            {{ card.definition ? 'Editar workflow' : 'Criar workflow' }}
          </button>

          <button
            mat-stroked-button
            type="button"
            (click)="export(card)"
            [disabled]="!card.definition"
            appAccessControl="workflow.configurar"
            [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
            <mat-icon>download</mat-icon>
            Exportar JSON
          </button>
        </div>
      </div>

      <ng-template #loadingCardTpl>
        <div class="workflow-origin-loading">Carregando...</div>
      </ng-template>
    </article>
  </section>

  <section
    *ngIf="canUseModule && !selectedMovimentoConfigId && !loadingConfigs"
    class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 text-sm text-[var(--muted)] shadow-[var(--shadow-xs)]">
    Selecione uma configuracao de movimento para configurar os workflows.
  </section>

  <ng-template #moduleDisabledTpl>
    <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 text-sm text-[var(--muted)] shadow-[var(--shadow-xs)]">
      Modulo de workflow desabilitado por feature flag.
    </section>
  </ng-template>
</div>
