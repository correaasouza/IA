<div class="grid gap-3">
  <header class="page-header-sticky flex flex-col items-start justify-between gap-3 md:flex-row md:items-end">
    <div>
      <h1 class="m-0 text-lg font-bold">{{ title }}</h1>
      <p class="mt-1 text-xs text-[var(--muted)]">Ficha de movimento de estoque</p>
      <p class="mt-1 text-xs text-[var(--muted-strong)]">Nome: {{ nomeAtual() }}</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button mat-stroked-button type="button" (click)="back()">
        <mat-icon>arrow_back</mat-icon>
        Voltar
      </button>

      <button
        mat-stroked-button
        type="button"
        *ngIf="mode === 'view' && movimento"
        (click)="toEdit()"
        appAccessControl="movimentos.estoque.update"
        [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
        <mat-icon>edit</mat-icon>
        Editar
      </button>

      <button
        mat-flat-button
        color="primary"
        type="button"
        *ngIf="mode === 'new'"
        (click)="save()"
        [disabled]="saving || form.invalid || !!errorMessage"
        appAccessControl="movimentos.estoque.create"
        [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
        <mat-icon>save</mat-icon>
        Salvar
      </button>

      <button
        mat-flat-button
        color="primary"
        type="button"
        *ngIf="mode === 'edit'"
        (click)="save()"
        [disabled]="saving || form.invalid || !!errorMessage"
        appAccessControl="movimentos.estoque.update"
        [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
        <mat-icon>save</mat-icon>
        Salvar
      </button>

      <button
        mat-button
        color="warn"
        type="button"
        *ngIf="mode !== 'new' && movimento"
        (click)="remove()"
        [disabled]="deleting"
        appAccessControl="movimentos.estoque.delete"
        [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
        <mat-icon>delete</mat-icon>
        Excluir
      </button>
    </div>
  </header>

  <section class="rounded-xl border border-dashed border-[var(--border)] bg-[var(--surface-muted)] px-2.5 py-2 text-xs text-[var(--muted-strong)]" *ngIf="mode === 'new'">
    Fluxo: a ficha foi pre-carregada com base na configuracao aplicavel da empresa selecionada no contexto.
  </section>

  <section class="rounded-xl border border-dashed border-[#fda29b] bg-[#fef3f2] p-3 text-sm text-[#b42318]" *ngIf="errorMessage">
    {{ errorMessage }}
  </section>

  <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]" *ngIf="templateData">
    <div class="mb-2.5 text-sm font-semibold">Padroes carregados da configuracao</div>
    <div class="grid grid-cols-1 gap-2 text-xs text-[var(--muted)] md:grid-cols-2">
      <div><span class="font-semibold text-[var(--ink)]">Configuracao:</span> #{{ templateData.movimentoConfigId }}</div>
      <div><span class="font-semibold text-[var(--ink)]">Destinatario padrao:</span> {{ templateData.tipoEntidadePadraoId ? ('#' + templateData.tipoEntidadePadraoId) : '-' }}</div>
      <div class="md:col-span-2">
        <span class="font-semibold text-[var(--ink)]">Destinatarios permitidos:</span>
        {{ (templateData.tiposEntidadePermitidos || []).length ? ('#' + templateData.tiposEntidadePermitidos.join(', #')) : '-' }}
      </div>
    </div>
  </section>

  <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]">
    <form [formGroup]="form" class="grid grid-cols-1 gap-2.5 md:grid-cols-2">
      <mat-form-field appearance="outline">
        <mat-label>Empresa</mat-label>
        <input matInput formControlName="empresaId" readonly />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Data do movimento</mat-label>
        <input matInput formControlName="dataMovimento" placeholder="DD/MM/AAAA" appDateMask />
        <mat-error *ngIf="form.get('dataMovimento')?.hasError('invalidDate')">Informe uma data valida (DD/MM/AAAA).</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="md:col-span-2">
        <mat-label>Nome</mat-label>
        <input matInput formControlName="nome" maxlength="120" />
        <mat-hint align="end">{{ (form.get('nome')?.value || '').length }}/120</mat-hint>
        <mat-error *ngIf="form.get('nome')?.hasError('required')">Informe o nome do movimento.</mat-error>
      </mat-form-field>
    </form>

    <div class="mt-2 flex justify-end" *ngIf="loading" role="status" aria-live="polite">
      <app-inline-loader label="Carregando ficha"></app-inline-loader>
    </div>
    <div class="mt-2 flex justify-end" *ngIf="saving" role="status" aria-live="polite">
      <app-inline-loader label="Salvando ficha"></app-inline-loader>
    </div>
    <div class="mt-2 flex justify-end" *ngIf="deleting" role="status" aria-live="polite">
      <app-inline-loader label="Excluindo movimento"></app-inline-loader>
    </div>
  </section>
</div>
