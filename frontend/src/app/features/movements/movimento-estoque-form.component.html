<div class="page-form-shell grid gap-3">
  <header class="page-header-sticky movimento-form-header">
    <div class="movimento-header-main">
      <div>
        <h1 class="m-0 text-lg font-bold">{{ title }}</h1>
        <p class="mt-1 text-xs text-[var(--muted-strong)] movimento-header-summary">
          Empresa: {{ empresaAtual() }} | Nome: {{ nomeAtual() }} | Ajuste estoque: {{ stockAdjustmentAtual() }}
          <ng-container *ngIf="hasTiposEntidadeConfigurados()"> | Destinatario: {{ tipoEntidadeAtual() }}</ng-container>
        </p>
      </div>
      <div class="movimento-header-actions">
        <button mat-stroked-button type="button" (click)="back()">
          <mat-icon>arrow_back</mat-icon>
          Voltar
        </button>

        <button
          mat-stroked-button
          type="button"
          *ngIf="mode === 'view' && movimento"
          (click)="toEdit()"
          appAccessControl="movimentos.estoque.update"
          [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
          <mat-icon>edit</mat-icon>
          Editar
        </button>

        <button
          mat-flat-button
          color="primary"
          type="button"
          *ngIf="mode !== 'view'"
          (click)="save()"
          [disabled]="saving || form.invalid || !!errorMessage"
          [appAccessControl]="mode === 'edit' ? 'movimentos.estoque.update' : 'movimentos.estoque.create'"
          [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
          <mat-icon>save</mat-icon>
          Salvar
        </button>

        <button
          mat-button
          color="warn"
          type="button"
          *ngIf="mode !== 'new' && movimento"
          (click)="remove()"
          [disabled]="deleting"
          appAccessControl="movimentos.estoque.delete"
          [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
          <mat-icon>delete</mat-icon>
          Excluir
        </button>
      </div>
    </div>

    <section class="movimento-section-nav">
      <div class="movimento-section-buttons" *ngIf="!isMobileView">
        <button
          type="button"
          class="movimento-section-btn"
          [class.movimento-section-btn-active]="selectedTabIndex === 0"
          (click)="selectedTabIndex = 0">
          Dados do movimento
        </button>
        <button
          type="button"
          class="movimento-section-btn"
          [class.movimento-section-btn-active]="selectedTabIndex === 1"
          (click)="selectedTabIndex = 1">
          Itens do movimento
          <span class="movimento-tab-counter">{{ savedItemsView.length }}</span>
        </button>
      </div>

      <mat-form-field appearance="outline" class="movimento-section-select" *ngIf="isMobileView">
        <mat-label>Secao</mat-label>
        <mat-select [(value)]="selectedTabIndex">
          <mat-option [value]="0">{{ sectionLabel(0) }}</mat-option>
          <mat-option [value]="1">{{ sectionLabel(1) }}</mat-option>
        </mat-select>
      </mat-form-field>
    </section>
  </header>

  <section class="rounded-xl border border-dashed border-[#fda29b] bg-[#fef3f2] p-3 text-sm text-[#b42318]" *ngIf="errorMessage">
    {{ errorMessage }}
  </section>

  <div class="movimento-section-content" *ngIf="selectedTabIndex === 0">
    <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]">
      <form [formGroup]="form" class="grid grid-cols-1 gap-2.5">
        <mat-form-field appearance="outline" class="md:col-span-2">
          <mat-label>Nome</mat-label>
          <input matInput formControlName="nome" maxlength="120" [readonly]="mode === 'view'" />
          <mat-hint align="end">{{ (form.get('nome')?.value || '').length }}/120</mat-hint>
          <mat-error *ngIf="form.get('nome')?.hasError('required')">Informe o nome do movimento.</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="hasTiposEntidadeConfigurados()">
          <mat-label>Destinatario do movimento</mat-label>
          <mat-select formControlName="tipoEntidadeId" [disabled]="mode === 'view'">
            <mat-option [value]="null">Selecione</mat-option>
            <mat-option *ngFor="let tipoEntidadeId of tiposEntidadePermitidosView" [value]="tipoEntidadeId">
              {{ tipoEntidadeOptionLabel(tipoEntidadeId) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tipo de ajuste de estoque</mat-label>
          <mat-select formControlName="stockAdjustmentId" [disabled]="mode === 'view'">
            <mat-option [value]="null">Selecione</mat-option>
            <mat-option *ngFor="let adjustment of stockAdjustmentsView" [value]="adjustment.id">
              {{ stockAdjustmentOptionLabel(adjustment) }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </form>
    </section>
  </div>

  <div class="movimento-section-content" *ngIf="selectedTabIndex === 1">
    <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-3 shadow-[var(--shadow-xs)]">
      <div class="mb-1 flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm font-semibold">
          Itens do movimento
          <span class="movimento-item-inline-hint" *ngIf="isCatalogSelectorOpen()"> - Adicionar itens do catalogo | Selecione grupo, busque e adicione em lote</span>
        </div>
        <button
          class="movimento-new-item-btn"
          mat-stroked-button
          type="button"
          *ngIf="mode !== 'view'"
          (click)="openCatalogSelector()"
          [disabled]="!canRenderCatalogSelector()">
          <mat-icon>add</mat-icon>
          Novo item
        </button>
      </div>

      <ng-container *ngIf="mode !== 'view' && isCatalogSelectorOpen() && catalogSelectorData() as selectorData">
        <app-movimento-catalog-selector-dialog
          [embedded]="true"
          [panelData]="selectorData"
          (confirmSelection)="onCatalogSelectorAdd($event)"
          (closeSelection)="closeCatalogSelector()"
          (selectorStateChange)="onCatalogSelectorStateChange($event)">
        </app-movimento-catalog-selector-dialog>
      </ng-container>

      <app-movimento-itens-list
        [items]="savedItemsView"
        [inlineEditEnabled]="false"
        [showWorkflowTransitions]="workflowEnabled && mode !== 'new'"
        [transitionsByItem]="itemTransitionsByItemId"
        [stateNamesByItemId]="itemStateNamesByItemId"
        [stateKeysByItemId]="itemStateKeysByItemId"
        [stateColorsByStateKey]="itemStateColorsByStateKey"
        [itemSaving]="saving"
        [emptyMessage]="'Nenhum item salvo.'"
        [actionButtonsEnabled]="true"
        (consultItem)="onSavedItemConsult($event)"
        (editItem)="onSavedItemEdit($event)"
        (transitionItem)="onSavedItemTransition($event)"
        (deleteItem)="onSavedItemDelete($event)">
      </app-movimento-itens-list>

      <div class="mt-2 text-right text-sm font-semibold">
        Total cobrado: {{ itensTotalCobrado() | number : '1.2-6' }}
      </div>
    </section>
  </div>

  <div class="mt-2 flex justify-end" *ngIf="loading" role="status" aria-live="polite">
    <app-inline-loader label="Carregando ficha"></app-inline-loader>
  </div>
  <div class="mt-2 flex justify-end" *ngIf="saving" role="status" aria-live="polite">
    <app-inline-loader label="Salvando ficha"></app-inline-loader>
  </div>
  <div class="mt-2 flex justify-end" *ngIf="deleting" role="status" aria-live="polite">
    <app-inline-loader label="Excluindo movimento"></app-inline-loader>
  </div>
</div>
