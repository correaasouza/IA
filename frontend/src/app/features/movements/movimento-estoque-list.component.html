<div class="grid gap-2">
  <div class="page-list-sticky grid gap-2">
    <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-2 shadow-[var(--shadow-xs)]">
      <div class="grid grid-cols-1 gap-2 md:grid-cols-[auto_minmax(0,1fr)_auto] md:items-center">
        <div class="min-w-0">
          <h1 class="m-0 text-base font-bold">Movimento de Estoque</h1>
          <p class="mt-0.5 text-[11px] text-[var(--muted)]">Lista da empresa selecionada no contexto.</p>
        </div>

        <div class="grid gap-1.5 min-w-0">
          <div class="flex items-center justify-between gap-2 md:hidden">
            <button mat-button type="button" class="mobile-filter-toggle" (click)="toggleMobileFilters()">
              <mat-icon>tune</mat-icon>
              Filtros{{ activeFiltersCount() > 0 ? ' (' + activeFiltersCount() + ')' : '' }}
              <mat-icon class="mobile-filter-chevron">{{ mobileFiltersOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
            <div class="text-xs text-[var(--muted)]">{{ totalElements }} movimento(s)</div>
          </div>

          <form *ngIf="!isMobile || mobileFiltersOpen" class="grid grid-cols-1 items-start gap-1.5 md:grid-cols-[minmax(0,1fr)_auto]" role="search">
            <div class="min-w-0">
              <app-field-search
                [options]="searchOptions"
                label="Buscar"
                placeholder="Digite e selecione os campos"
                [defaultFields]="searchFields"
                [showActions]="false"
                (searchChange)="onSearchChange($event)">
              </app-field-search>
            </div>

            <div class="flex items-center justify-end gap-2">
              <button mat-stroked-button type="button" (click)="clearFilters()">
                Limpar
              </button>
            </div>
          </form>
        </div>

        <div class="flex items-center justify-between gap-2 md:justify-end">
          <div class="hidden text-xs text-[var(--muted)] md:block">{{ totalElements }} movimento(s)</div>
          <button
            mat-flat-button
            color="primary"
            type="button"
            (click)="newMovimento()"
            appAccessControl="movimentos.estoque.create"
            [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
            <mat-icon>add</mat-icon>
            Novo movimento
          </button>
        </div>
      </div>
    </section>
  </div>

  <section class="rounded-xl border border-[var(--border)] bg-[var(--surface)] p-0 shadow-[var(--shadow-xs)]" *ngIf="rows.length > 0">
    <div class="hidden md:block">
      <div class="list-pane-head list-pane-head--movimentos">
        <span class="list-pane-head-title font-semibold">
          <mat-icon class="list-pane-head-icon" style="position: relative; top: 8px;">inventory_2</mat-icon>
          <span>Movimentos</span>
        </span>
        <span class="list-pane-head-meta text-xs text-[var(--muted)]">
          {{ rows.length }} linha(s) nesta pagina
        </span>
      </div>

      <div #movimentosPane class="table-sticky-actions movements-grid-pane overflow-auto border-b border-[var(--border-light)]" (scroll)="onMovimentosScroll($event)">
        <table mat-table [dataSource]="rows" class="w-full movements-grid-table">
          <ng-container matColumnDef="nome">
            <th mat-header-cell *matHeaderCellDef>Movimento</th>
            <td mat-cell *matCellDef="let row">{{ row.nome }}</td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Situacao</th>
            <td mat-cell *matCellDef="let row">
              <span
                class="movement-status-badge"
                [class.movement-status-badge--default]="!movementStatusColor(row)"
                [style.--status-color]="movementStatusColor(row)">
                {{ movementStatus(row) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="movimentoConfig">
            <th mat-header-cell *matHeaderCellDef>Config</th>
            <td mat-cell *matCellDef="let row">#{{ row.movimentoConfigId }}</td>
          </ng-container>

          <ng-container matColumnDef="tipoEntidadePadrao" *ngIf="showTipoEntidadePadrao">
            <th mat-header-cell *matHeaderCellDef>Destinatario</th>
            <td mat-cell *matCellDef="let row">{{ row.tipoEntidadePadraoId ? ('#' + row.tipoEntidadePadraoId) : '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="acoes" stickyEnd>
            <th mat-header-cell *matHeaderCellDef class="text-right">Acoes</th>
            <td mat-cell *matCellDef="let row" class="flex flex-nowrap justify-end gap-1.5">
              <button mat-icon-button matTooltip="Consultar" (click)="view(row)" [attr.aria-label]="'Consultar ' + row.nome">
                <mat-icon>visibility</mat-icon>
              </button>
              <button
                mat-icon-button
                matTooltip="Alterar"
                (click)="edit(row)"
                [attr.aria-label]="'Alterar ' + row.nome"
                appAccessControl="movimentos.estoque.update"
                [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                matTooltip="Excluir"
                (click)="remove(row)"
                [attr.aria-label]="'Excluir ' + row.nome"
                appAccessControl="movimentos.estoque.delete"
                [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
                <mat-icon>delete</mat-icon>
              </button>
              <button
                mat-icon-button
                matTooltip="Transicionar situacao"
                [matMenuTriggerFor]="movementTransitionMenu"
                [disabled]="itemSaving || movementTransitions(row).length === 0">
                <mat-icon>sync_alt</mat-icon>
              </button>
              <mat-menu #movementTransitionMenu="matMenu">
                <button
                  mat-menu-item
                  *ngFor="let transition of movementTransitions(row)"
                  (click)="onTransitionMovement(row, transition.key)">
                  <span>{{ transition.name }}<ng-container *ngIf="transition.toStateName"> -> {{ transition.toStateName }}</ng-container></span>
                </button>
                <button mat-menu-item disabled *ngIf="movementTransitions(row).length === 0">
                  <span>Sem transicoes disponiveis</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            (click)="selectRow(row)"
            [class.selected-row]="isSelected(row)"></tr>
        </table>
      </div>
      <div class="px-2 py-1 text-xs text-[var(--muted)]">
        {{ rows.length }} de {{ totalElements }} movimentos
        <span *ngIf="loadingMoreRows"> | Carregando mais...</span>
      </div>

      <mat-divider></mat-divider>

      <div class="list-pane-head list-pane-head--itens">
        <span class="list-pane-head-title font-semibold">
          <mat-icon class="list-pane-head-icon" style="position: relative; top: 8px;">receipt_long</mat-icon>
          <span>Itens do Movimento Selecionado</span>
        </span>
        <span class="list-pane-head-meta text-xs text-[var(--muted)]" *ngIf="selectedRow() as selected">
          {{ selected.itens.length }} item(ns) | total: {{ selected.totalCobrado | number : '1.2-6' }}
        </span>
      </div>

      <div #itensPane class="items-grid-pane overflow-auto" (scroll)="onItensScroll($event)">
        <app-movimento-itens-list
          [items]="visibleSelectedItems()"
          [inlineEditEnabled]="false"
          [itemSaving]="itemSaving"
          [showWorkflowTransitions]="workflowEnabled"
          [transitionsByItem]="itemTransitionsByItemId"
          [stateNamesByItemId]="itemStateNamesByItemId"
          [stateKeysByItemId]="itemStateKeysByItemId"
          [stateColorsByStateKey]="itemStateColorsByStateKey"
          [emptyMessage]="'Movimento sem itens.'"
          (consultItem)="consultItem($event)"
          (editItem)="openItemOnMovimentoForm($event)"
          (transitionItem)="onTransitionItem($event)"
          (deleteItem)="removeItem($event)">
        </app-movimento-itens-list>
      </div>
      <div class="px-2 py-1 text-xs text-[var(--muted)]">
        {{ visibleSelectedItems().length }} de {{ selectedItems().length }} itens visiveis
      </div>

    </div>

    <div class="grid gap-2.5 p-3 md:hidden">
      <article class="grid gap-2 rounded-xl border border-[var(--border)] bg-[var(--surface)] p-2.5 shadow-[var(--shadow-xs)]" *ngFor="let row of rows">
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm font-semibold">{{ row.nome }}</div>
        </div>
        <div class="text-xs text-[var(--muted)]">Config: #{{ row.movimentoConfigId }}</div>
        <div class="text-xs text-[var(--muted)]">
          Situacao:
          <span
            class="movement-status-badge"
            [class.movement-status-badge--default]="!movementStatusColor(row)"
            [style.--status-color]="movementStatusColor(row)">
            {{ movementStatus(row) }}
          </span>
        </div>
        <div class="text-xs text-[var(--muted)]" *ngIf="showTipoEntidadePadrao">Destinatario padrao: {{ row.tipoEntidadePadraoId ? ('#' + row.tipoEntidadePadraoId) : '-' }}</div>
        <div class="text-xs text-[var(--muted)]">Itens: {{ row.totalItens }} | Total: {{ row.totalCobrado | number : '1.2-6' }}</div>
        <div class="flex justify-end gap-1.5">
          <button mat-icon-button [matMenuTriggerFor]="rowMenu" aria-label="Acoes do movimento">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #rowMenu="matMenu">
            <button mat-menu-item (click)="view(row)">
              <mat-icon>visibility</mat-icon>
              <span>Consultar</span>
            </button>
            <button
              mat-menu-item
              (click)="edit(row)"
              appAccessControl="movimentos.estoque.update"
              [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
              <mat-icon>edit</mat-icon>
              <span>Alterar</span>
            </button>
            <button
              mat-menu-item
              (click)="remove(row)"
              appAccessControl="movimentos.estoque.delete"
              [appAccessFallbackRoles]="['MASTER', 'ADMIN']">
              <mat-icon>delete</mat-icon>
              <span>Excluir</span>
            </button>
            <button
              mat-menu-item
              [disabled]="itemSaving || movementTransitions(row).length === 0"
              [matMenuTriggerFor]="movementTransitionMenuMobile">
              <mat-icon>sync_alt</mat-icon>
              <span>Transicionar situacao</span>
            </button>
          </mat-menu>
          <mat-menu #movementTransitionMenuMobile="matMenu">
            <button
              mat-menu-item
              *ngFor="let transition of movementTransitions(row)"
              (click)="onTransitionMovement(row, transition.key)">
              <span>{{ transition.name }}<ng-container *ngIf="transition.toStateName"> -> {{ transition.toStateName }}</ng-container></span>
            </button>
            <button mat-menu-item disabled *ngIf="movementTransitions(row).length === 0">
              <span>Sem transicoes disponiveis</span>
            </button>
          </mat-menu>
        </div>
      </article>

      <div class="text-xs text-[var(--muted)]">
        {{ rows.length }} de {{ totalElements }} movimentos
        <span *ngIf="loadingMoreRows"> | Carregando mais...</span>
      </div>
    </div>

  </section>

  <section class="rounded-xl border border-dashed border-[var(--border)] bg-[var(--surface)] p-4 text-[var(--muted)]" *ngIf="rows.length === 0">
    <div class="font-semibold text-[var(--ink)]">{{ loading ? 'Carregando movimentos...' : 'Nenhum movimento encontrado' }}</div>
    <div class="text-xs">Ajuste os filtros ou crie um novo movimento de estoque.</div>
  </section>
</div>
